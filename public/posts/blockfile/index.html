<!DOCTYPE html>
<html lang="en-us">
  <head>
    

<meta property="og:title" content="Blockfile" />
<meta property="og:description" content="Blockfile and Hosts Database Specification Last updated: 2020-09 Accurate for: 0.9.47
Overview This document specifies the I2P blockfile file format and the tables in the hostsdb.blockfile used by the Blockfile Naming Service [NAMING].
The blockfile provides fast Destination lookup in a compact format. While the blockfile page overhead is substantial, the destinations are stored in binary rather than in Base 64 as in the hosts.txt format. In addition, the blockfile provides the capability of arbitrary metadata storage (such as added date, source, and comments) for each entry." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://eyedeekay.github.io/i2p.spec/posts/blockfile/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-27T14:39:35-04:00" />
<meta property="article:modified_time" content="2021-04-27T14:39:35-04:00" />



<meta name="description" content="I2P SPecifications" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>I2P Specifications</title>
    
<link rel="icon" type="image/png" href="/i2p.spec/images/favicon.png" />
<link href="https://fonts.googleapis.com/css?family=Open&#43;Sans:400,600" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/i2p.spec/style.sass" integrity="">
<link rel="stylesheet" type="text/css" href="/i2p.spec/css/icons.css">

  </head>
  <body>
    
    <div id="preloader">
      <div id="status"></div>
    </div>

    

    

<nav class="navbar is-fresh is-transparent no-shadow" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/i2p.spec/images/logos/fresh.svg" alt="" width="112" height="28">
      </a>
      <a class="navbar-item is-hidden-desktop is-hidden-tablet">
        <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
          <svg width="1000px" height="1000px">
            <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
            <path class="path2" d="M 300 500 L 700 500"></path>
            <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
          </svg>
          <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
        </div>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

      <div id="navbar-menu" class="navbar-menu is-static">
        <div class="navbar-start">
          <a class="navbar-item is-hidden-mobile">
            <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
              <svg width="1000px" height="1000px">
                <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
                <path class="path2" d="M 300 500 L 700 500"></path>
                <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
              </svg>
              <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
            </div>
          </a>
        </div>

        <div class="navbar-end">
          <a href="/" class="navbar-item is-secondary">
            Features
          </a>
          <a href="/" class="navbar-item is-secondary">
            Pricing
          </a>
          <div class="navbar-item has-dropdown is-hoverable">
            <a class="navbar-link">
              Dropdown
            </a>

            <div class="navbar-dropdown">
              <a href="/" class="navbar-item">
                Dropdown item
              </a>
              <a href="/" class="navbar-item">
                Dropdown item
              </a>
              <a href="/" class="navbar-item">
                Dropdown item
              </a>
            </div>
          </div>
          <a href="/" class="navbar-item is-secondary">
            Log in
          </a>
          <a href="/" class="navbar-item">
            <span class="button signup-button rounded secondary-btn raised">
              Sign up
            </span>
          </a>
        </div>
      </div>
  </div>
</nav>



<nav id="navbar-clone" class="navbar is-fresh is-transparent" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/i2p.spec/images/logos/fresh.svg" alt="" width="112" height="28">
      </a>
      <a class="navbar-item is-hidden-desktop is-hidden-tablet">
        <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
          <svg width="1000px" height="1000px">
            <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
            <path class="path2" d="M 300 500 L 700 500"></path>
            <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
          </svg>
          <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
        </div>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="cloned-navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="cloned-navbar-menu" class="navbar-menu is-fixed">
      <div class="navbar-start">
        <a class="navbar-item is-hidden-mobile">
          <div id="cloned-menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
            <svg width="1000px" height="1000px">
              <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
              <path class="path2" d="M 300 500 L 700 500"></path>
              <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
            </svg>
            <button id="cloned-menu-icon-trigger" class="menu-icon-trigger"></button>
          </div>
        </a>
      </div>

      <div class="navbar-end">
        <a href="/" class="navbar-item is-secondary">
          Features
        </a>
        <a href="/" class="navbar-item is-secondary">
          Pricing
        </a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">
            Dropdown
          </a>

          <div class="navbar-dropdown">
            <a href="/" class="navbar-item">
              Dropdown item
            </a>
            <a href="/" class="navbar-item">
              Dropdown item
            </a>
            <a href="/" class="navbar-item">
              Dropdown item
            </a>
          </div>
        </div>
        <a href="/" class="navbar-item is-secondary">
          Log in
        </a>
        <a href="/" class="navbar-item">
          <span class="button signup-button rounded secondary-btn raised">
            Sign up
          </span>
        </a>
      </div>
    </div>
</div>
</nav>

<section class="section is-medium">
  <div class="container">
    <div class="columns">
      <div class="column is-centered-tablet-portrait">
        <h1 class="title section-title">Blockfile</h1>
        <h5 class="subtitle is-5 is-muted"></h5>
        <div class="divider"></div>
      </div>
    </div>
    <h1 id="blockfile-and-hosts-database-specification">Blockfile and Hosts Database Specification</h1>
<p>Last updated: 2020-09 Accurate for: 0.9.47</p>
<h2 id="overview">Overview</h2>
<p>This document specifies the I2P blockfile file format and the tables in
the hostsdb.blockfile used by the Blockfile Naming Service [NAMING].</p>
<p>The blockfile provides fast Destination lookup in a compact format.
While the blockfile page overhead is substantial, the destinations are
stored in binary rather than in Base 64 as in the hosts.txt format. In
addition, the blockfile provides the capability of arbitrary metadata
storage (such as added date, source, and comments) for each entry. The
metadata may be used in the future to provide advanced addressbook
features. The blockfile storage requirement is a modest increase over
the hosts.txt format, and the blockfile provides approximately 10x
reduction in lookup times.</p>
<p>A blockfile is simply on-disk storage of multiple sorted maps (key-value
pairs), implemented as skiplists. The blockfile format is adopted from
the Metanotion Blockfile Database [METANOTION]. First we will define
the file format, then the use of that format by the
BlockfileNamingService.</p>
<h2 id="blockfile-format">Blockfile Format</h2>
<p>The original blockfile spec was modified to add magic numbers to each
page. The file is structured in 1024-byte pages. Pages are numbered
starting from 1. The &quot;superblock&quot; is always at page 1, i.e. starting
at byte 0 in the file. The metaindex skiplist is always at page 2, i.e.
starting at byte 1024 in the file.</p>
<p>All 2-byte integer values are unsigned. All 4-byte integer values (page
numbers) are signed and negative values are illegal. All integer values
are stored in network byte order (big endian).</p>
<p>The database is designed to be opened and accessed by a single thread.
The BlockfileNamingService provides synchronization.</p>
<p>Superblock format:</p>
<blockquote>
<p>Byte Contents 0-5 Magic number 0x3141de493250 (&quot;1A&quot; 0xde &quot;I2P&quot;) 6
Major version 0x01 7 Minor version 0x02 8-15 File length Total length
in bytes 16-19 First free list page 20-21 Mounted flag 0x01 = yes
22-23 Span size Max number of key/value pairs per span (16 for
hostsdb) Used for new skip lists. 24-27 Page size As of version 1.2.
Prior to 1.2, 1024 is assumed. 28-1023 unused</p>
</blockquote>
<p>Skip list block page format:</p>
<blockquote>
<p>Byte Contents 0-7 Magic number 0x536b69704c697374 &quot;SkipList&quot; 8-11
First span page 12-15 First level page 16-19 Size (total number of
keys - may only be valid at startup) 20-23 Spans (total number of
spans - may only be valid at startup) 24-27 Levels (total number of
levels - may only be valid at startup) 28-29 Span size - As of version
1.2. Max number of key/value pairs per span. Prior to that, specified
for all skiplists in the superblock. Used for new spans in this skip
list. 30-1023 unused</p>
</blockquote>
<p>Skip level block page format is as follows. All levels have a span. Not
all spans have levels.</p>
<blockquote>
<p>Byte Contents 0-7 Magic number 0x42534c6576656c73 &quot;BSLevels&quot; 8-9 Max
height 10-11 Current height 12-15 Span page 16- Next level pages
('current height' entries, 4 bytes each, lowest first) remaining
bytes unused</p>
</blockquote>
<p>Skip span block page format is as follows. Key/value structures are
sorted by key within each span and across all spans. Key/value
structures are sorted by key within each span. Spans other than the
first span may not be empty.</p>
<blockquote>
<p>Byte Contents 0-3 Magic number 0x5370616e &quot;Span&quot; 4-7 First
continuation page or 0 8-11 Previous span page or 0 12-15 Next span
page or 0 16-17 Max keys (16 for hostsdb) 18-19 Size (current number
of keys) 20-1023 key/value structures</p>
</blockquote>
<p>Span Continuation block page format:</p>
<blockquote>
<p>Byte Contents 0-3 Magic number 0x434f4e54 &quot;CONT&quot; 4-7 Next
continuation page or 0 8-1023 key/value structures</p>
</blockquote>
<p>Key/value structure format is as follows. Key and value lengths must not
be split across pages, i.e. all 4 bytes must be on the same page. If
there is not enough room the last 1-3 bytes of a page are unused and the
lengths will be at offset 8 in the continuation page. Key and value data
may be split across pages. Max key and value lengths are 65535 bytes.</p>
<blockquote>
<p>Byte Contents 0-1 key length in bytes 2-3 value length in bytes 4- key
data value data</p>
</blockquote>
<p>Free list block page format:</p>
<blockquote>
<p>Byte Contents 0-7 Magic number 0x2366724c69737423 &quot;#frList#&quot; 8-11
Next free list block or 0 if none 12-15 Number of valid free pages in
this block (0 - 252) 16-1023 Free pages (4 bytes each), only the first
(valid number) are valid</p>
</blockquote>
<p>Free page block format:</p>
<blockquote>
<p>Byte Contents 0-7 Magic number 0x7e2146524545217e &quot;~!FREE!~&quot;
8-1023 unused</p>
</blockquote>
<p>The metaindex (located at page 2) is a mapping of US-ASCII strings to
4-byte integers. The key is the name of the skiplist and the value is
the page index of the skiplist.</p>
<h2 id="blockfile-naming-service-tables">Blockfile Naming Service Tables</h2>
<p>The tables created and used by the BlockfileNamingService are as
follows. The maximum number of entries per span is 16.</p>
<h3 id="properties-skiplist">Properties Skiplist</h3>
<p>&quot;%%__INFO__%%&quot; is the main database skiplist with
String/Properties key/value entries containing only one entry:</p>
<blockquote>
<dl>
<dt>info</dt>
<dd>a Properties (UTF-8 String/String Map), serialized as a
[Mapping] :
<dl>
<dt>version</dt>
<dd>
<p>&quot;4&quot;</p>
</dd>
<dt>created</dt>
<dd>
<p>Java long time (ms)</p>
</dd>
<dt>upgraded</dt>
<dd>
<p>Java long time (ms) (as of database version 2)</p>
</dd>
<dt>lists</dt>
<dd>
<p>Comma-separated list of host databases, to be searched
in-order for lookups. Almost always
&quot;privatehosts.txt,userhosts.txt,hosts.txt&quot;.</p>
</dd>
</dl>
</dd>
</dl>
</blockquote>
<h3 id="reverse-lookup-skiplist">Reverse Lookup Skiplist</h3>
<p>&quot;%%__REVERSE__%%&quot; is the reverse lookup skiplist with
Integer/Properties key/value entries (as of database version 2):</p>
<ul>
<li>The skiplist keys are 4-byte Integers, the first 4 bytes of the hash
of the [Destination].</li>
<li>The skiplist values are each a Properties (a UTF-8 String/String
Map) serialized as a [Mapping]
<ul>
<li>There may be multiple entries in the properties, each one is a
reverse mapping, as there may be more than one hostname for a
given destination, or there could be collisions with the same
first 4 bytes of the hash.</li>
<li>Each property key is a hostname.</li>
<li>Each property value is the empty string.</li>
</ul>
</li>
</ul>
<h3 id="hoststxt-userhoststxt-and-privatehoststxt-skiplists">hosts.txt, userhosts.txt, and privatehosts.txt Skiplists</h3>
<p>For each host database, there is a skiplist containing the hosts for
that database. Note that the version 4 format supports multiple
Destinations per hostname. This format was introduced in I2P release
0.9.26. Version 3 databases are automatically migrated to verrsion 4.</p>
<p>The keys/values in these skiplists are as follows:</p>
<blockquote>
<dl>
<dt>key</dt>
<dd>a UTF-8 String (the hostname)</dd>
<dt>value</dt>
<dd>Database version 4: A DestEntry, which is: A one-byte number of
Properties/Destination pairs to follow That number of pairs of: A
Properties (a UTF-8 String/String Map) serialized as a [Mapping]
followed by a binary [Destination] (serialized as usual).
<p>Database version 3: a DestEntry, which is a Properties (a UTF-8
String/String Map) serialized as a [Mapping] followed by a
binary [Destination] (serialized as usual).</p>
</dd>
</dl>
</blockquote>
<p>The DestEntry Properties typically contains:</p>
<blockquote>
<dl>
<dt>&quot;a&quot;</dt>
<dd>The time added (Java long time in ms)</dd>
<dt>&quot;a&quot;</dt>
<dd>The time added (Java long time in ms)</dd>
<dt>&quot;notes&quot;</dt>
<dd>User-supplied comments</dd>
<dt>&quot;s&quot;</dt>
<dd>The original source of the entry (typically a file name or
subscription URL)</dd>
<dt>&quot;v&quot;</dt>
<dd>If the signature of the entry was verified, &quot;true&quot; or &quot;false&quot;</dd>
</dl>
</blockquote>
<p>Hostname keys are stored in lower-case and always end in &quot;.i2p&quot;.</p>
<h2 id="references">References</h2>
<dl>
<dt>[Destination]</dt>
<dd>
<p><a href="https://geti2p.net/spec/common-structures#struct-destination">https://geti2p.net/spec/common-structures#struct-destination</a></p>
</dd>
<dt>[Mapping]</dt>
<dd>
<p><a href="https://geti2p.net/spec/common-structures#type-mapping">https://geti2p.net/spec/common-structures#type-mapping</a></p>
</dd>
<dt>[METANOTION]</dt>
<dd>
<p><a href="http://www.metanotion.net/software/sandbox/block.html">http://www.metanotion.net/software/sandbox/block.html</a></p>
</dd>
<dt>[NAMING]</dt>
<dd>
<p><a href="https://geti2p.net/en/docs/naming">https://geti2p.net/en/docs/naming</a></p>
</dd>
</dl>

  </div>
</section>



    

    
    <div id="backtotop"><a href="#"></a></div>

    

    

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="/i2p.spec/js/fresh.js"></script>
<script src="/i2p.spec/js/jquery.panelslider.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  </body>
</html>
